include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'

unit_tests:
  extends: .baremetal-runner-daint-gh200
  script:
    - echo "Preparing the test environment (multiple ranks)"
    - export MPICH_GPU_SUPPORT_ENABLED=1
    - export IGG_CUDAAWARE_MPI=1 # IGG
    - export JULIA_CUDA_USE_COMPAT=false # IGG
    - export JULIA_JUSTRELAX_BACKEND=CUDA
    - export JULIA_CSCS_CI=true
    - srun -n 1 --uenv julia/25.5:v1 --view=juliaup julia --project=. -e 'using Pkg; Pkg.instantiate();'
    - srun -n 1 --uenv julia/25.5:v1 --view=juliaup julia --project=. -e 'using Pkg; Pkg.add(["Suppressor", "Test"]);'
    - srun -n 1 --uenv julia/25.5:v1 --view=juliaup julia --project=. -e 'using Pkg; Pkg.add(name="OpenSSL_jll", version="3.0.16");'
    - srun -n 1 --uenv julia/25.5:v1 --view=juliaup julia --project=. -e 'using Pkg; Pkg.add(name="CUDA", version="5.8.2");'
    - srun -n 1 --uenv julia/25.5:v1 --view=juliaup julia --project=. -e 'using Pkg; Pkg.status(); using CUDA; CUDA.versioninfo();'
    - echo "Running MPI tests (multiple ranks)"
    - echo "Running MPI test - test_diffusion2D_multiphase_MPI.jl"
    - srun --uenv julia/25.5:v1 --view=juliaup julia --project=. --startup-file=no test/test_diffusion2D_multiphase_MPI.jl
    - echo "Running MPI test - test_diffusion3D_multiphase_MPI.jl"
    - srun --uenv julia/25.5:v1 --view=juliaup julia --project=. --startup-file=no test/test_diffusion3D_multiphase_MPI.jl
    - echo "Running MPI test - test_shearband2D_MPI.jl"
    - srun --uenv julia/25.5:v1 --view=juliaup julia --project=. --startup-file=no test/test_shearband2D_MPI.jl
    - echo "Running MPI test - test_shearband3D_MPI.jl"
    - srun --uenv julia/25.5:v1 --view=juliaup julia --project=. --startup-file=no test/test_shearband3D_MPI.jl
    - echo "All MPI tests completed"
  variables:
    SLURM_JOB_NUM_NODES: 2
    SLURM_NTASKS_PER_NODE: 4
    SLURM_GPUS_PER_TASK: 1
    SLURM_TIMELIMIT: "00:30:00"

ref_test:
  extends: .baremetal-runner-daint-gh200
  script:
    - echo "Preparing the test environment (single rank)"
    - export MPICH_GPU_SUPPORT_ENABLED=1
    - export IGG_CUDAAWARE_MPI=1 # IGG
    - export JULIA_CUDA_USE_COMPAT=false # IGG
    - export JULIA_JUSTRELAX_BACKEND=CUDA
    - export JULIA_CSCS_CI=true
    - srun -n 1 --uenv julia/25.5:v1 --view=juliaup julia --project=. -e 'using Pkg; Pkg.instantiate();'
    - srun -n 1 --uenv julia/25.5:v1 --view=juliaup julia --project=. -e 'using Pkg; Pkg.add(["Suppressor", "Test"]);'
    - srun -n 1 --uenv julia/25.5:v1 --view=juliaup julia --project=. -e 'using Pkg; Pkg.add(name="OpenSSL_jll", version="3.0.16");'
    - srun -n 1 --uenv julia/25.5:v1 --view=juliaup julia --project=. -e 'using Pkg; Pkg.add(name="CUDA", version="5.8.2");'
    - srun -n 1 --uenv julia/25.5:v1 --view=juliaup julia --project=. -e 'using Pkg; Pkg.status(); using CUDA; CUDA.versioninfo();'
    - echo "Running the reference test (multiple ranks)"
    - srun --uenv julia/25.5:v1 --view=juliaup julia --project=. test/test_shearband3D_MPI.jl
  variables:
    SLURM_JOB_NUM_NODES: 2
    SLURM_NTASKS_PER_NODE: 4
    SLURM_GPUS_PER_TASK: 1
    SLURM_TIMELIMIT: "00:15:00"

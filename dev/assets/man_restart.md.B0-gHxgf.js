import{_ as s,o as a,c as t,aA as e}from"./chunks/framework.Cm4pDAuj.js";const c=JSON.parse('{"title":"Restarting from a Checkpoint File","description":"","frontmatter":{},"headers":[],"relativePath":"man/restart.md","filePath":"man/restart.md","lastUpdated":null}'),n={name:"man/restart.md"};function l(h,i,p,k,d,r){return a(),t("div",null,[...i[0]||(i[0]=[e(`<h1 id="Restarting-from-a-Checkpoint-File" tabindex="-1">Restarting from a Checkpoint File <a class="header-anchor" href="#Restarting-from-a-Checkpoint-File" aria-label="Permalink to &quot;Restarting from a Checkpoint File {#Restarting-from-a-Checkpoint-File}&quot;">​</a></h1><p>To restart a simulation from a previously saved checkpoint file, you can make use of the checkpointing functions described in the <a href="./checkpointing">Checkpointing documentation</a>. Depending on the file format you used to save your checkpoint (HDF5 or JLD2), you can load the saved state of your simulation using the corresponding loading function.</p><p>In this example, we will demonstrate how to set up a script to restart a simulation from a JLD2 checkpoint file as we can save the entire structures of the <code>StokesArrays</code> and <code>ThermalArrays</code> which makes it easier to restart the simulation. We will assume that you have already saved a checkpoint file using the <code>checkpointing_jld2</code> function for the example of a 2D subduction model. Ideally, one does not need to change much in the initial script used to start the simulation from scratch. The main difference is that instead of initializing the <code>StokesArrays</code> and <code>ThermalArrays</code> from scratch, we will load them from the checkpoint file. For a detailed description of the 2D subduction model setup, please refer to the <a href="./subduction2D/subduction2D">2D subduction documentation</a>. The following example can be found <a href="https://github.com/PTsolvers/JustRelax.jl/blob/d63ca8f08860859700913b575c9befc33d5c4f2a/miniapps/subduction/2D/Subduction2D_restart" target="_blank" rel="noreferrer">here</a>.</p><p>Load JustRelax necessary modules and define backend.</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CUDA </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># comment this out if you are not using CUDA; or load AMDGPU.jl if you are using an AMD GPU</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JustRelax, JustRelax</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">JustRelax2D, JustRelax</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DataIO</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend_JR </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CUDABackend  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Options: CPUBackend, CUDABackend, AMDGPUBackend</span></span></code></pre></div><p>For this benchmark we will use particles to track the advection of the material phases and their information. For this, we will use <a href="https://github.com/JuliaGeodynamics/JustPIC.jl" target="_blank" rel="noreferrer">JustPIC.jl</a></p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JustPIC, JustPIC</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_2D</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CUDABackend </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Options: JustPIC.CPUBackend, CUDABackend, JustPIC.AMDGPUBackend</span></span></code></pre></div><p>!!! tip &quot;Script&quot; Leave most of your original script unchanged and only change the parts we highlight in this example, unless you want to explicitly change some model parameters (e.g., rheology, boundary conditions, etc.). Make sure you dont accidentally overwrite your loaded arrays/particles with new initializations.</p><h2 id="Load-and-initialize-particles-fields" tabindex="-1">Load and initialize particles fields <a class="header-anchor" href="#Load-and-initialize-particles-fields" aria-label="Permalink to &quot;Load and initialize particles fields {#Load-and-initialize-particles-fields}&quot;">​</a></h2><p>The <code>JustPIC</code> specific function <code>TA()</code> will convert the loaded particles to the correct backend.</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">joinpath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Your_checkpointing_directory&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;particles.jld2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">particles     </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(backend)(Float64, data[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;particles&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">phases        </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(backend)(Float64, data[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;phases&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">phase_ratios  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(backend)(Float64, data[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;phase_ratios&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">particle_args </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> TA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(backend).(Float64, data[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;particle_args&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">subgrid_arrays  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> SubgridDiffusionCellArrays</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(particles)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># velocity staggered grids</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">grid_vxi        </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> velocity_grids</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(xci, xvi, di)</span></span></code></pre></div><h2 id="Load-Stokes-and-Thermal-arrays-from-checkpoint-file" tabindex="-1">Load Stokes and Thermal arrays from checkpoint file <a class="header-anchor" href="#Load-Stokes-and-Thermal-arrays-from-checkpoint-file" aria-label="Permalink to &quot;Load Stokes and Thermal arrays from checkpoint file {#Load-Stokes-and-Thermal-arrays-from-checkpoint-file}&quot;">​</a></h2><div class="vp-code-group vp-adaptive-theme"><div class="tabs"><input type="radio" name="group-o3-Gb" id="tab-libSnYL" checked><label data-title="Normal use" for="tab-libSnYL">Normal use</label><input type="radio" name="group-o3-Gb" id="tab-_w8ltQA"><label data-title="MPI" for="tab-_w8ltQA">MPI</label><input type="radio" name="group-o3-Gb" id="tab-BYK5QYD"><label data-title="Additional fields" for="tab-BYK5QYD">Additional fields</label></div><div class="blocks"><div class="language-julia vp-adaptive-theme active"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dst </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Your_checkpointing_directory&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">stokes_cpu, thermal_cpu, t, dt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> load_checkpoint_jld2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dst)</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dst </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Your_checkpointing_directory&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">stokes_cpu, thermal_cpu, t, dt </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> load_checkpoint_jld2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dst, igg)</span></span></code></pre></div><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dst </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Your_checkpointing_directory&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fname </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> joinpath</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dst, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;checkpoint&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> lpad</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">$(igg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">me)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;0&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;.jld2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">stokes_cpu, thermal_cpu, t, dt, it, custom_field_1, custom_field_2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> JLD2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(fname)</span></span></code></pre></div></div></div><p>The loaded arrays are CPU arrays, so we need to convert them to the correct backend.</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">stokes </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PTArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(backend_JR, stokes_cpu)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">thermal </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PTArray</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(backend_JR, thermal_cpu)</span></span></code></pre></div><p>From here on you should be able to continue the simulation as usual. Make sure to adjust the time loop to start from the loaded time <code>t</code> and iteration <code>it</code> if you loaded them.</p>`,16)])])}const E=s(n,[["render",l]]);export{c as __pageData,E as default};
